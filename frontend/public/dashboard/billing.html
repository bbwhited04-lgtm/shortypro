<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShortyPro — Billing</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/shared/brand.css" />
</head>
<body class="bg-slate-50 text-slate-900">
  <script src="/shared/brand.js"></script>
  <script src="/dashboard/config.js"></script>
  <script>DeadAppCorpBrand.mount({ dba:"ShortyPro", links:{ primaryCtaLabel:"Dashboard", primaryCtaHref:"/dashboard/" } });</script>

  <main class="mx-auto max-w-5xl px-4 py-10">
    <h1 class="text-2xl font-bold tracking-tight">Billing</h1>
    <p class="mt-2 text-sm text-slate-600">Connect your Stripe payment links (or backend endpoint) in <code class="rounded bg-white px-1.5 py-0.5 border border-slate-200">/dashboard/config.js</code>.</p>

    <div class="mt-6 grid gap-4 md:grid-cols-3" id="plans"></div>

    <div class="mt-8 rounded-3xl border border-slate-200 bg-white p-6">
      <div class="text-sm font-semibold">Customer portal</div>
      <p class="mt-2 text-sm text-slate-600">If your backend supports it, send users to Stripe’s customer portal for invoices and cancellations.</p>
      <button id="portalBtn" class="mt-4 rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50">
        Open customer portal
      </button>
    </div>
  </main>

  <script>
    const cfg = window.SHORTYPRO_CONFIG;
    const plansEl = document.getElementById("plans");

    function planCard(key, p){
      return `
        <div class="rounded-3xl border border-slate-200 bg-white p-6">
          <div class="text-sm font-semibold">${p.label}</div>
          <div class="mt-2 text-3xl font-bold">${p.price}</div>
          <button data-plan="${key}" class="mt-5 w-full rounded-2xl bg-slate-900 px-4 py-3 text-sm font-semibold text-white hover:bg-slate-800">
            Buy ${p.label}
          </button>
          <div class="mt-3 text-xs text-slate-500">Edit links in /dashboard/config.js</div>
        </div>
      `;
    }

    plansEl.innerHTML = Object.entries(cfg.pricing).map(([k,v])=>planCard(k,v)).join("");

    async function postJSON(url, body){
      const res = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body||{}) });
      if(!res.ok) throw new Error("Request failed: "+res.status);
      return await res.json();
    }

    document.querySelectorAll("button[data-plan]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const plan = btn.getAttribute("data-plan");
        btn.disabled = true;
        btn.textContent = "Loading…";
        try{
          if(cfg.api?.createCheckoutSession){
            const data = await postJSON(cfg.api.createCheckoutSession, { plan });
            const url = data.url || data.checkout_url;
            if(url) return (location.href = url);
          }
          // Fallback: direct payment link
          const link = cfg.pricing?.[plan]?.stripePaymentLink;
          if(link && !link.includes("PASTE_STRIPE_PAYMENT_LINK")) return (location.href = link);
          alert("Stripe link not set. Edit /dashboard/config.js and paste your Stripe payment links.");
        }catch(e){
          alert("Checkout not available yet. If you have a backend endpoint, verify cfg.api.createCheckoutSession.");
        }finally{
          btn.disabled = false;
          btn.textContent = "Buy " + cfg.pricing[plan].label;
        }
      });
    });

    document.getElementById("portalBtn").addEventListener("click", async ()=>{
      try{
        if(cfg.api?.customerPortal){
          const data = await postJSON(cfg.api.customerPortal, {});
          const url = data.url || data.portal_url;
          if(url) return (location.href = url);
        }
        alert("Portal endpoint not configured. Set cfg.api.customerPortal in /dashboard/config.js");
      }catch(e){
        alert("Portal not available yet.");
      }
    });
  </script>
</body>
</html>
